<div id="monthlyExamsContent" class="space-y-6">
    <div class="text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="mt-4 text-gray-600">Loading monthly exams...</p>
    </div>
</div>

<script>
(function() {
    let examsData = [];
    let refreshInterval = null;
    let isExpanded = {};
    
    async function loadExams() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        console.log('üìö Student Monthly Exams - User data:', user);
        console.log('üìö user.allBatchIds:', user.allBatchIds);
        console.log('üìö user.batches:', user.batches);
        console.log('üìö user.batchId:', user.batchId);
        
        // Get ALL batch IDs from user session
        let batchIds = user.allBatchIds || [];
        
        // Fallback to batches array if allBatchIds not available
        if (!batchIds.length) {
            let batches = user.batches || [];
            console.log('üìö Fallback to batches array:', batches);
            if (!batches.length && user.allStudents && user.allStudents.length > 0) {
                console.log('üìö Fallback to allStudents:', user.allStudents);
                const firstStudent = user.allStudents[0];
                batches = firstStudent.batches || [];
            }
            batchIds = batches.map(b => b.id);
        }
        
        const container = document.getElementById('monthlyExamsContent');
        
        if (!batchIds.length) {
            console.error('‚ùå No batch IDs found! User object:', user);
            container.innerHTML = '<div class="text-center py-12"><div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 max-w-md mx-auto"><p class="text-gray-700 font-medium mb-2">No batches assigned</p><p class="text-sm text-gray-600">Please contact your teacher to be assigned to a batch.</p><p class="text-xs text-gray-500 mt-2">Debug: Check console (F12) for user data</p></div></div>';
            return;
        }
        
        console.log('üìö Loading monthly exams from batches:', batchIds);
        
        try {
            // Load exams from ALL batches
            const promises = batchIds.map(batchId => 
                fetch('/api/monthly-exams?batch_id=' + batchId).then(r => r.json())
            );
            
            const results = await Promise.all(promises);
            
            // Combine all exam data from all batches
            let allExams = [];
            results.forEach(data => {
                if (data.success && data.data && data.data.length > 0) {
                    allExams = allExams.concat(data.data);
                }
            });
            
            if (allExams.length > 0) {
                // Sort by exam date (newest first)
                examsData = allExams.sort((a, b) => new Date(b.exam_date) - new Date(a.exam_date));
                console.log('‚úÖ Loaded', examsData.length, 'exams from', batchIds.length, 'batch(es)');
                renderExamCards(user);
                
                // Start auto-refresh every 30 seconds
                if (!refreshInterval) {
                    refreshInterval = setInterval(() => {
                        console.log('üîÑ Auto-refreshing exam data...');
                        refreshExamData(user);
                    }, 30000); // 30 seconds
                }
            } else {
                container.innerHTML = '<div class="text-center py-12"><div class="bg-gray-50 border border-gray-200 rounded-lg p-8 max-w-md mx-auto"><i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i><p class="text-gray-700 font-medium">No monthly exams available</p><p class="text-sm text-gray-500 mt-2">Your teacher hasn\'t created any monthly exams yet.</p></div></div>';
            }
        } catch (err) {
            console.error('Error loading exams:', err);
            container.innerHTML = '<div class="text-center py-12"><div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto"><i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i><p class="text-red-700 font-medium">Error loading exams</p><p class="text-sm text-red-600 mt-2">' + err.message + '</p></div></div>';
        }
    }
    
    async function refreshExamData(user) {
        // Get ALL batch IDs from user session
        let batchIds = user.allBatchIds || [];
        
        // Fallback to batches array if allBatchIds not available
        if (!batchIds.length) {
            const batches = user.batches || [];
            batchIds = batches.map(b => b.id);
        }
        
        if (!batchIds.length) return;
        
        try {
            // Load exams from ALL batches
            const promises = batchIds.map(batchId => 
                fetch('/api/monthly-exams?batch_id=' + batchId).then(r => r.json())
            );
            
            const results = await Promise.all(promises);
            
            // Combine all exam data from all batches
            let allExams = [];
            results.forEach(data => {
                if (data.success && data.data) {
                    allExams = allExams.concat(data.data);
                }
            });
            
            // Sort by exam date
            allExams = allExams.sort((a, b) => new Date(b.exam_date) - new Date(a.exam_date));
            
            const oldData = JSON.stringify(examsData);
            const newData = JSON.stringify(allExams);
            
            if (oldData !== newData) {
                console.log('‚ú® New data detected! Updating...');
                examsData = allExams;
                
                // Re-render cards
                renderExamCards(user);
                
                // Re-load expanded exam details
                for (let index in isExpanded) {
                    if (isExpanded[index]) {
                        const examId = examsData[index].id;
                        await loadExamDetails(parseInt(index), examId);
                    }
                }
                
                // Show update notification
                showUpdateNotification();
            }
        } catch (err) {
            console.error('Error refreshing data:', err);
        }
    }
    
    function showUpdateNotification() {
        const notification = document.createElement('div');
        notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce';
        notification.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Results updated!';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.remove('animate-bounce');
            notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }
    
    function renderExamCards(user) {
        const container = document.getElementById('monthlyExamsContent');
        let html = '';
        
        examsData.forEach((exam, index) => {
            html += '<div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow border border-gray-200">';
            
            // Clickable Card Header
            html += '<div class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white p-6 cursor-pointer" onclick="toggleExamDetails(' + index + ', ' + exam.id + ')">';
            html += '<div class="flex justify-between items-start">';
            html += '<div class="flex-1">';
            html += '<h3 class="text-xl font-bold mb-2">' + exam.title + '</h3>';
            html += '<p class="text-indigo-100 text-sm mb-3">' + exam.batch_name + '</p>';
            html += '<div class="flex flex-wrap gap-2">';
            html += '<span class="bg-white/20 px-3 py-1 rounded-full text-xs"><i class="far fa-calendar mr-1"></i>' + exam.month_name + ' ' + exam.year + '</span>';
            html += '<span class="bg-white/20 px-3 py-1 rounded-full text-xs"><i class="fas fa-award mr-1"></i>' + exam.total_marks + ' marks</span>';
            html += '<span class="bg-white/20 px-3 py-1 rounded-full text-xs"><i class="fas fa-check-circle mr-1"></i>' + exam.status + '</span>';
            html += '</div></div>';
            html += '<div class="ml-4">';
            html += '<i id="arrow-' + index + '" class="fas fa-chevron-down text-2xl transition-transform' + (isExpanded[index] ? ' rotate-180' : '') + '"></i>';
            html += '</div></div></div>';
            
            // Expandable Details Section
            html += '<div id="exam-details-' + index + '" class="' + (isExpanded[index] ? '' : 'hidden') + '">';
            if (!isExpanded[index]) {
                html += '<div class="p-6 bg-gray-50">';
                html += '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-indigo-600 text-2xl"></i><p class="mt-2 text-gray-600">Loading details...</p></div>';
                html += '</div>';
            }
            html += '</div>';
            
            html += '</div>';
        });
        
        container.innerHTML = html;
    }
    
    window.toggleExamDetails = async function(index, examId) {
        const detailsDiv = document.getElementById('exam-details-' + index);
        const arrow = document.getElementById('arrow-' + index);
        
        if (detailsDiv.classList.contains('hidden')) {
            // Expand and load data
            isExpanded[index] = true;
            detailsDiv.classList.remove('hidden');
            arrow.classList.add('rotate-180');
            await loadExamDetails(index, examId);
        } else {
            // Collapse
            isExpanded[index] = false;
            detailsDiv.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    };
    
    async function loadExamDetails(index, examId) {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const exam = examsData[index];
        const detailsDiv = document.getElementById('exam-details-' + index);
        
        try {
            // Fetch individual exams
            const indExamsResponse = await fetch('/api/monthly-exams/' + examId + '/individual-exams');
            const indExamsData = await indExamsResponse.json();
            
            // Fetch rankings
            const rankingsResponse = await fetch('/api/monthly-exams/' + examId + '/ranking');
            const rankingsData = await rankingsResponse.json();
            
            let html = '<div class="p-6 space-y-6">';
            
            // Individual Exams Section
            html += '<div>';
            html += '<h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">';
            html += '<i class="fas fa-clipboard-list text-indigo-600 mr-2"></i> Individual Exams';
            html += '</h3>';
            
            const individualExams = indExamsData.data?.individual_exams || [];
            const rankings = rankingsData.data?.nearby_rankings || [];
            
            // Get all student IDs for this user (handles multi-student accounts)
            const allStudentIds = [];
            if (user.id) allStudentIds.push(user.id);
            if (user.allStudents && user.allStudents.length > 0) {
                user.allStudents.forEach(student => {
                    if (!allStudentIds.includes(student.id)) {
                        allStudentIds.push(student.id);
                    }
                });
            }
            
            // Find ALL students' rank data (for multi-student accounts)
            const myRankDataArray = rankings.filter(r => allStudentIds.includes(r.user_id));
            const myRankData = myRankDataArray[0]; // For backward compatibility
            
            if (individualExams.length > 0) {
                html += '<div class="grid md:grid-cols-2 gap-4 mb-6">';
                individualExams.forEach(indExam => {
                    // Get student's marks for this exam from myRankData
                    const studentMark = myRankData?.individual_marks?.[indExam.id];
                    const marksObtained = studentMark?.marks_obtained;
                    const isAbsent = studentMark?.is_absent;
                    const grade = studentMark?.grade;
                    const percentage = studentMark?.percentage;
                    
                    html += '<div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">';
                    html += '<div class="flex justify-between items-start">';
                    html += '<div class="flex-1">';
                    html += '<h4 class="font-semibold text-gray-800">' + (indExam.subject || indExam.title) + '</h4>';
                    html += '<p class="text-sm text-gray-600 mt-1">' + (indExam.title || '') + '</p>';
                    if (indExam.exam_date) {
                        html += '<p class="text-xs text-gray-500 mt-2"><i class="far fa-calendar mr-1"></i>' + new Date(indExam.exam_date).toLocaleDateString() + '</p>';
                    }
                    
                    // Show student's result if available
                    if (studentMark) {
                        if (isAbsent) {
                            html += '<div class="mt-3 inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-800 text-sm font-medium">';
                            html += '<i class="fas fa-times-circle mr-1"></i> Absent';
                            html += '</div>';
                        } else {
                            html += '<div class="mt-3 flex items-center gap-2">';
                            html += '<span class="text-sm text-gray-600">Your Score:</span>';
                            html += '<span class="font-bold text-green-600">' + marksObtained + '/' + indExam.marks + '</span>';
                            html += '<span class="px-2 py-0.5 rounded bg-indigo-100 text-indigo-800 text-xs font-semibold">' + grade + '</span>';
                            html += '</div>';
                        }
                    }
                    html += '</div>';
                    html += '<div class="text-right ml-4">';
                    html += '<div class="text-3xl font-bold text-indigo-600">' + indExam.marks + '</div>';
                    html += '<div class="text-xs text-gray-500">Total</div>';
                    html += '</div></div></div>';
                });
                html += '</div>';
                
                // Total Summary
                html += '<div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4">';
                html += '<div class="flex justify-between items-center">';
                html += '<span class="font-bold text-gray-800">Total Marks:</span>';
                html += '<span class="text-3xl font-bold text-indigo-600">' + exam.total_marks + '</span>';
                html += '</div></div>';
            } else {
                html += '<p class="text-gray-500 italic">No individual exams added yet</p>';
            }
            html += '</div>';
            
            // Rankings Section
            html += '<div>';
            html += '<h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">';
            html += '<i class="fas fa-trophy text-yellow-500 mr-2"></i> Rankings & Results';
            html += '</h3>';
            
            if (rankings.length > 0) {
                // Show results for ALL students in multi-student accounts
                if (myRankDataArray.length > 0) {
                    myRankDataArray.forEach((myRank, index) => {
                        const borderColor = index === 0 ? 'border-green-400' : 'border-blue-400';
                        const bgColor = index === 0 ? 'from-green-50 to-emerald-50' : 'from-blue-50 to-indigo-50';
                        const badgeColor = index === 0 ? 'bg-green-500' : 'bg-blue-500';
                        
                        html += '<div class="bg-gradient-to-r ' + bgColor + ' border-2 ' + borderColor + ' rounded-lg p-5 mb-4">';
                        html += '<div class="flex items-center justify-between">';
                        html += '<div class="flex items-center gap-4">';
                        html += '<div class="' + badgeColor + ' text-white rounded-full w-16 h-16 flex items-center justify-center">';
                        html += '<span class="text-2xl font-bold">#' + myRank.position + '</span>';
                        html += '</div>';
                        html += '<div>';
                        html += '<div class="text-sm text-gray-600">' + (myRankDataArray.length > 1 ? 'Student Rank' : 'Your Rank') + '</div>';
                        html += '<div class="font-bold text-gray-800 text-lg">' + myRank.student_name + '</div>';
                        html += '</div></div>';
                        html += '<div class="text-right">';
                        html += '<div class="text-3xl font-bold text-gray-800">' + myRank.total_exam_marks + '<span class="text-lg text-gray-500">/' + exam.total_marks + '</span></div>';
                        html += '<div class="text-xl font-semibold text-green-600">' + myRank.percentage.toFixed(1) + '% ¬∑ ' + myRank.grade + '</div>';
                        html += '</div></div></div>';
                    });
                }
                
                // Rankings Table
                html += '<div class="bg-white rounded-lg border border-gray-200 overflow-hidden">';
                html += '<table class="min-w-full">';
                html += '<thead class="bg-gray-100 border-b border-gray-200">';
                html += '<tr>';
                html += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Rank</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Student</th>';
                html += '<th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Marks</th>';
                html += '<th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">%</th>';
                html += '<th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Grade</th>';
                html += '</tr></thead>';
                html += '<tbody class="divide-y divide-gray-200">';
                
                rankings.forEach((rank, idx) => {
                    // Highlight ALL students in multi-student accounts
                    const isMyRank = allStudentIds.includes(rank.user_id);
                    const rowClass = isMyRank ? 'bg-green-50 font-semibold' : 'hover:bg-gray-50';
                    const medalIcon = idx === 0 ? 'ü•á ' : idx === 1 ? 'ü•à ' : idx === 2 ? 'ü•â ' : '';
                    
                    html += '<tr class="' + rowClass + '">';
                    html += '<td class="px-4 py-3 text-center"><span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-indigo-100 text-indigo-800 font-bold text-sm">' + medalIcon + rank.position + '</span></td>';
                    html += '<td class="px-4 py-3 text-gray-800">' + rank.student_name + '</td>';
                    html += '<td class="px-4 py-3 text-center font-semibold text-gray-900">' + rank.total_exam_marks + '<span class="text-gray-500">/' + exam.total_marks + '</span></td>';
                    html += '<td class="px-4 py-3 text-center font-semibold text-indigo-600">' + rank.percentage.toFixed(1) + '%</td>';
                    html += '<td class="px-4 py-3 text-center"><span class="px-3 py-1 rounded-full text-sm font-semibold bg-indigo-100 text-indigo-800">' + rank.grade + '</span></td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
            } else {
                html += '<p class="text-gray-500 italic text-center py-8">No results published yet</p>';
            }
            html += '</div>';
            
            html += '</div>';
            
            detailsDiv.innerHTML = html;
        } catch (err) {
            console.error('Error loading exam details:', err);
            detailsDiv.innerHTML = '<div class="p-6 text-center text-red-600">Error loading details: ' + err.message + '</div>';
        }
    }
    
    setTimeout(loadExams, 500);
})();
</script>
