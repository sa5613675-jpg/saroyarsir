<!-- Student Documents - Read Only -->
<div class="bg-white shadow-lg rounded-lg p-6">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">üìö Online Resources</h2>
        <p class="text-gray-600">Download study materials, books, question banks, and homework</p>
    </div>

    <div class="mb-4 flex flex-wrap gap-2">
        <button onclick="filterDocuments('all')" class="filter-btn px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
            üìã All Documents
        </button>
        <button onclick="filterDocuments('online-books')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
            üìñ Online Books
        </button>
        <button onclick="filterDocuments('question-bank')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
            ‚ùì Question Banks
        </button>
        <button onclick="filterDocuments('homework')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
            üìù Homework
        </button>
    </div>

    <div id="documentsLoading" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Loading documents...</p>
    </div>

    <div id="documentsContainer" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>

<script>
// Student Documents Module v2.0.2 - Build: 2025-11-13 - Force Load Fix
console.log('üìÑ Documents Module Loading v2.0.2');

// Make variables global for access from parent
window.currentFilter = 'all';
window.allDocuments = [];
window.documentsLoaded = false;

window.loadDocuments = function() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    console.log('üìÑ Documents - User data:', user);
    console.log('üìÑ User batches:', user.batches);
    console.log('üìÑ User allBatchIds:', user.allBatchIds);
    
    if (window.documentsLoaded && window.allDocuments.length > 0) {
        console.log('üìÑ Documents already loaded:', window.allDocuments.length);
        return;
    }
    
    console.log('üì° Loading documents from /api/documents/');
    fetch('/api/documents/?include_inactive=true', {
        credentials: 'same-origin'
    })
        .then(function(response) {
            console.log('üì° Documents response status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            console.log('üìÑ Documents data:', data);
            if (data.success && data.data && data.data.documents) {
                window.allDocuments = data.data.documents;
                window.documentsLoaded = true;
                console.log('‚úÖ Total documents loaded:', window.allDocuments.length);
                renderDocuments(window.allDocuments);
            } else {
                console.warn('‚ö†Ô∏è No documents found in response');
                window.allDocuments = [];
                window.documentsLoaded = true;
            }
            document.getElementById('documentsLoading').classList.add('hidden');
            document.getElementById('documentsContainer').classList.remove('hidden');
        })
        .catch(function(error) {
            console.error('‚ùå Error loading documents:', error);
            document.getElementById('documentsLoading').innerHTML = '<p class="text-red-600">Failed to load documents. Please refresh.</p>';
            window.documentsLoaded = false;
        });
};

function filterDocuments(category) {
    window.currentFilter = category;
    var buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(function(btn) {
        btn.classList.remove('bg-indigo-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    event.target.classList.remove('bg-gray-200', 'text-gray-700');
    event.target.classList.add('bg-indigo-600', 'text-white');
    
    var filtered = window.allDocuments;
    if (category !== 'all') {
        filtered = window.allDocuments.filter(function(doc) {
            return doc.description && doc.description.indexOf('[' + category + ']') !== -1;
        });
    }
    renderDocuments(filtered);
}

function renderDocuments(documents) {
    var container = document.getElementById('documentsContainer');
    if (documents.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500"><p>No documents found</p></div>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < documents.length; i++) {
        var doc = documents[i];
        // Determine category and icon
        var category = 'üìã Document';
        var categoryClass = 'bg-blue-100 text-blue-800';
        
        if (doc.description) {
            if (doc.description.indexOf('[online-books]') !== -1) {
                category = 'üìñ Book';
                categoryClass = 'bg-green-100 text-green-800';
            } else if (doc.description.indexOf('[question-bank]') !== -1) {
                category = '‚ùì Question';
                categoryClass = 'bg-purple-100 text-purple-800';
            } else if (doc.description.indexOf('[homework]') !== -1) {
                category = 'üìù Homework';
                categoryClass = 'bg-orange-100 text-orange-800';
            }
        }
        
        // Format created date
        var createdDate = new Date(doc.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        var createdTime = new Date(doc.created_at).toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        html += '<div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">';
        html += '<div class="flex items-center justify-between mb-2">';
        html += '<span class="text-xs px-2 py-1 rounded ' + categoryClass + '">' + category + '</span>';
        html += '<span class="text-xs text-gray-500">' + doc.file_size_mb + ' MB</span>';
        html += '</div>';
        html += '<h3 class="font-semibold text-gray-900 mb-1">' + doc.chapter_name + '</h3>';
        html += '<p class="text-sm text-gray-600 mb-2">' + doc.class_name + ' ‚Ä¢ ' + doc.book_name + '</p>';
        html += '<p class="text-xs text-gray-500 mb-3">üìÖ Uploaded: ' + createdDate + ' at ' + createdTime + '</p>';
        html += '<a href="/api/documents/' + doc.id + '/download" class="block w-full text-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">';
        html += '<i class="fas fa-download mr-2"></i>Download';
        html += '</a>';
        html += '</div>';
    }
    container.innerHTML = html;
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    var section = document.getElementById('online-resourcesSection');
    if (section && !section.classList.contains('hidden')) {
        console.log('Online Resources: Initializing on page load');
        window.loadDocuments();
    }
});

// Watch for section visibility changes
if (document.getElementById('online-resourcesSection')) {
    var resourcesObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            var section = document.getElementById('online-resourcesSection');
            if (section && !section.classList.contains('hidden') && window.allDocuments.length === 0) {
                console.log('Online Resources: Section became visible, loading...');
                window.loadDocuments();
                resourcesObserver.disconnect();
            }
        });
    });
    
    resourcesObserver.observe(document.body, { attributes: true, subtree: true, attributeFilter: ['class'] });
}
</script>
