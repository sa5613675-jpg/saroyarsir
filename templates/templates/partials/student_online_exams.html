<!-- Student Online Exams - Simple Module v3.0 -->
<div class="bg-white shadow-lg rounded-lg p-6">
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">üìù Online Exams</h2>
        <p class="text-gray-600">Take MCQ exams and see instant results</p>
    </div>

    <!-- Loading State -->
    <div id="examsLoading" class="text-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
        <p class="text-gray-600">Loading exams...</p>
    </div>

    <!-- Exams List -->
    <div id="examsContainer" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4"></div>

    <!-- Exam Taking Modal -->
    <div id="examModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg w-full max-w-3xl">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg w-full max-w-md">
                <!-- Results content will be inserted here -->
            </div>
        </div>
    </div>
</div>

<script>
// Online Exams Module v3.0 - Simple JavaScript (No Alpine.js)
console.log('üìù Online Exams Module v3.0');

window.onlineExamsState = {
    allExams: [],
    activeExam: null,
    attemptId: null,
    questions: [],
    answers: {},
    timeRemaining: 0,
    timer: null,
    isSubmitting: false
};

window.loadOnlineExams = function() {
    console.log('üì° Loading online exams...');
    
    var loadingEl = document.getElementById('examsLoading');
    var containerEl = document.getElementById('examsContainer');
    
    if (!loadingEl || !containerEl) {
        console.error('‚ùå Elements not found');
        return;
    }
    
    fetch('/api/online-exams', {credentials: 'same-origin'})
        .then(function(response) {
            console.log('üì° Response status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            console.log('üì° Data received:', data);
            
            loadingEl.classList.add('hidden');
            containerEl.classList.remove('hidden');
            
            if (data.success && data.data) {
                window.onlineExamsState.allExams = data.data;
                console.log('‚úÖ Loaded', data.data.length, 'exams');
                renderExams();
            } else {
                console.warn('‚ö†Ô∏è No exam data in response');
                containerEl.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500"><p>No exams available</p></div>';
            }
        })
        .catch(function(error) {
            console.error('‚ùå Error loading exams:', error);
            loadingEl.classList.add('hidden');
            containerEl.classList.remove('hidden');
            containerEl.innerHTML = '<div class="col-span-full text-center py-8"><div class="text-red-600"><i class="fas fa-exclamation-circle text-3xl mb-2"></i><p class="font-semibold">Failed to load exams</p><p class="text-sm mt-2">' + error.message + '</p><button onclick="loadOnlineExams()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Retry</button></div></div>';
        });
};

function renderExams() {
    var container = document.getElementById('examsContainer');
    var exams = window.onlineExamsState.allExams;
    
    console.log('üé® Rendering exams:', exams);
    
    if (!exams || exams.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500"><p>No exams available</p></div>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < exams.length; i++) {
        var exam = exams[i];
        console.log('üìù Rendering exam:', exam);
        
        // Safe access with defaults
        var title = exam.title || 'Untitled Exam';
        var className = exam.class_name || '';
        var chapterName = exam.chapter_name || '';
        var duration = exam.duration || 0;
        var totalQuestions = exam.total_questions || 0;
        var passPercentage = exam.pass_percentage || 0;
        var attemptsCount = exam.attempts_count || 0;
        var bestScore = exam.best_score || null;
        
        html += '<div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">';
        html += '<h3 class="font-bold text-lg text-gray-900 mb-2">' + title + '</h3>';
        html += '<p class="text-sm text-gray-600 mb-2">' + className + ' ‚Ä¢ ' + chapterName + '</p>';
        html += '<div class="space-y-1 text-sm text-gray-700 mb-4">';
        html += '<p><i class="fas fa-clock text-indigo-600"></i> ' + duration + ' minutes</p>';
        html += '<p><i class="fas fa-question-circle text-indigo-600"></i> ' + totalQuestions + ' questions</p>';
        html += '<p><i class="fas fa-trophy text-indigo-600"></i> Pass: ' + passPercentage + '%</p>';
        if (attemptsCount > 0) {
            html += '<p class="text-green-600"><i class="fas fa-check-circle"></i> Attempts: ' + attemptsCount;
            if (bestScore !== null && bestScore !== undefined) {
                html += ' (Best: ' + bestScore + '%)';
            }
            html += '</p>';
        }
        html += '</div>';
        html += '<button onclick="startExam(' + exam.id + ')" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">';
        html += '<i class="fas fa-play mr-2"></i>' + (attemptsCount > 0 ? 'Take Again' : 'Start Exam');
        html += '</button>';
        html += '</div>';
    }
    container.innerHTML = html;
}

window.startExam = function(examId) {
    console.log('üé¨ Starting exam:', examId);
    
    fetch('/api/online-exams/' + examId + '/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    })
    .then(function(response) { 
        console.log('üì° Start response status:', response.status);
        return response.json().catch(function(err) {
            console.error('‚ùå Failed to parse start_exam JSON:', err);
            return { success: false, message: 'Failed to start exam: invalid server response' };
        }); 
    })
    .then(function(data) {
        console.log('üì° Start response data:', data);
        if (data.success && data.data) {
            var exam = window.onlineExamsState.allExams.find(function(e) { return e.id === examId; });
            if (!exam) {
                alert('Error: Exam not found');
                return;
            }
            window.onlineExamsState.activeExam = exam;
            window.onlineExamsState.attemptId = data.data.attempt_id;
            window.onlineExamsState.questions = data.data.questions;
            window.onlineExamsState.timeRemaining = exam.duration * 60;
            window.onlineExamsState.answers = {};
            showExamModal();
            startTimer();
        } else {
            var errorMsg = data && (data.message || data.error || data.detail) || 'Failed to start exam';
            console.error('‚ùå Start exam failed:', errorMsg, 'Raw data:', data);
            alert('Error: ' + errorMsg);
        }
    })
    .catch(function(error) {
        console.error('‚ùå Exception starting exam:', error);
        alert('Failed to start exam. Please check your connection.');
    });
};

function showExamModal() {
    var state = window.onlineExamsState;
    var modal = document.getElementById('examModal');
    
    var html = '<div class="bg-indigo-600 text-white px-6 py-4">';
    html += '<div class="flex justify-between items-center">';
    html += '<div><h3 class="text-xl font-bold">' + state.activeExam.title + '</h3>';
    html += '<p class="text-sm">' + state.activeExam.chapter_name + '</p></div>';
    html += '<div class="text-center"><div id="timer" class="text-3xl font-bold">30:00</div>';
    html += '<p class="text-xs">Time Left</p></div></div></div>';
    
    html += '<div class="p-6 max-h-96 overflow-y-auto">';
    for (var i = 0; i < state.questions.length; i++) {
        var q = state.questions[i];
        html += '<div class="mb-6 pb-6 border-b">';
        html += '<p class="font-semibold mb-3">' + (i + 1) + '. ' + q.question_text + '</p>';
        html += '<div class="space-y-2">';
        html += createOption(q.id, 'A', q.option_a);
        html += createOption(q.id, 'B', q.option_b);
        html += createOption(q.id, 'C', q.option_c);
        html += createOption(q.id, 'D', q.option_d);
        html += '</div></div>';
    }
    html += '</div>';
    
    html += '<div class="bg-gray-50 px-6 py-4 flex justify-between items-center">';
    html += '<p class="text-sm text-gray-600">Answered: <span id="answeredCount">0</span>/' + state.questions.length + '</p>';
    html += '<div class="space-x-2">';
    html += '<button onclick="exitExam()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Exit</button>';
    html += '<button onclick="submitExam()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Submit</button>';
    html += '</div></div>';
    
    modal.querySelector('.bg-white').innerHTML = html;
    modal.classList.remove('hidden');
}

function createOption(questionId, option, text) {
    return '<label class="flex items-center p-3 border rounded hover:bg-gray-50 cursor-pointer">' +
           '<input type="radio" name="q' + questionId + '" value="' + option + '" onchange="saveAnswer(' + questionId + ', \'' + option + '\')" class="mr-3">' +
           '<span>' + option + '. ' + text + '</span></label>';
}

window.saveAnswer = function(questionId, answer) {
    window.onlineExamsState.answers[questionId] = answer;
    var count = Object.keys(window.onlineExamsState.answers).length;
    var total = window.onlineExamsState.questions.length;
    
    document.getElementById('answeredCount').textContent = count;
    
    console.log('üíæ Answer saved:', count, '/', total);
    
    // Auto-submit if all questions answered
    if (count === total) {
        console.log('‚úÖ All questions answered! Auto-submitting in 1 second...');
        setTimeout(function() {
            if (Object.keys(window.onlineExamsState.answers).length === total) {
                console.log('üöÄ Auto-submitting exam...');
                submitExam();
            }
        }, 1000);
    }
    
    // Save to server
    fetch('/api/online-exams/attempts/' + window.onlineExamsState.attemptId + '/answer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({question_id: questionId, selected_answer: answer})
    });
};

function startTimer() {
    var state = window.onlineExamsState;
    if (state.timer) clearInterval(state.timer);
    
    state.timer = setInterval(function() {
        state.timeRemaining--;
        var mins = Math.floor(state.timeRemaining / 60);
        var secs = state.timeRemaining % 60;
        var timerElement = document.getElementById('timer');
        if (timerElement) {
            timerElement.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        if (state.timeRemaining <= 0) {
            clearInterval(state.timer);
            console.log('‚è∞ Time expired! Auto-submitting...');
            autoSubmit();
        }
    }, 1000);
}

function autoSubmit() {
    console.log('üî¥ AUTO-SUBMIT: Time expired');
    if (window.onlineExamsState.isSubmitting) {
        console.log('‚ö†Ô∏è Already submitting...');
        return;
    }
    
    window.onlineExamsState.isSubmitting = true;
    
    if (window.onlineExamsState.timer) {
        clearInterval(window.onlineExamsState.timer);
    }
    
    fetch('/api/online-exams/attempts/' + window.onlineExamsState.attemptId + '/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({auto_submit: true})
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        console.log('üì° Auto-submit response:', data);
        if (data.success && data.data) {
            showResults(data.data);
            document.getElementById('examModal').classList.add('hidden');
            window.onlineExamsState.isSubmitting = false;
            loadOnlineExams();
        } else {
            alert('Exam time expired and submitted.');
            document.getElementById('examModal').classList.add('hidden');
            window.onlineExamsState.isSubmitting = false;
        }
    })
    .catch(function(error) {
        console.error('‚ùå Auto-submit error:', error);
        alert('Time expired! Exam submitted.');
        document.getElementById('examModal').classList.add('hidden');
        window.onlineExamsState.isSubmitting = false;
    });
}

window.submitExam = function() {
    if (window.onlineExamsState.isSubmitting) {
        console.log('‚ö†Ô∏è Already submitting...');
        return;
    }
    window.onlineExamsState.isSubmitting = true;
    
    if (window.onlineExamsState.timer) clearInterval(window.onlineExamsState.timer);
    
    console.log('üì§ Submitting exam, attempt ID:', window.onlineExamsState.attemptId);
    
    fetch('/api/online-exams/attempts/' + window.onlineExamsState.attemptId + '/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin'
    })
    .then(function(response) { 
        console.log('üì° Submit response status:', response.status);
        return response.json(); 
    })
    .then(function(data) {
        console.log('üì° Submit response data:', data);
        if (data.success && data.data) {
            showResults(data.data);
            document.getElementById('examModal').classList.add('hidden');
            window.onlineExamsState.isSubmitting = false;
            loadOnlineExams(); // Reload exams list
        } else {
            var errorMsg = data.message || data.error || 'Failed to submit exam';
            console.error('‚ùå Submit failed:', errorMsg);
            alert('Error: ' + errorMsg);
            window.onlineExamsState.isSubmitting = false;
        }
    })
    .catch(function(error) {
        console.error('‚ùå Exception submitting exam:', error);
        alert('Failed to submit exam. Please check your connection.');
        window.onlineExamsState.isSubmitting = false;
    });
};

window.exitExam = function() {
    if (confirm('Exit exam? Your progress will be lost.')) {
        if (window.onlineExamsState.timer) clearInterval(window.onlineExamsState.timer);
        document.getElementById('examModal').classList.add('hidden');
        window.onlineExamsState.activeExam = null;
        window.onlineExamsState.isSubmitting = false;
    }
};

function showResults(results) {
    var modal = document.getElementById('resultsModal');
    var html = '<div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-8 text-center">';
    html += '<h3 class="text-2xl font-bold mb-2">Exam Results</h3>';
    html += '<div class="text-6xl font-bold my-4">' + results.percentage + '%</div>';
    html += '<p class="text-xl">' + (results.is_passed ? 'üéâ Passed!' : 'Keep trying!') + '</p></div>';
    
    html += '<div class="p-6">';
    html += '<div class="grid grid-cols-2 gap-4 mb-6">';
    html += '<div class="text-center p-4 bg-gray-50 rounded-lg">';
    html += '<div class="text-2xl font-bold">' + results.score + '</div>';
    html += '<div class="text-sm text-gray-600">Correct</div></div>';
    html += '<div class="text-center p-4 bg-gray-50 rounded-lg">';
    html += '<div class="text-2xl font-bold">' + results.total_marks + '</div>';
    html += '<div class="text-sm text-gray-600">Total</div></div></div>';
    html += '<p class="text-sm text-gray-600 mb-2"><i class="fas fa-clock mr-2"></i>Time: ' + results.time_taken + '</p>';
    html += '</div>';
    
    html += '<div class="bg-gray-50 px-6 py-4">';
    html += '<button onclick="closeResults()" class="w-full px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Close</button>';
    html += '</div>';
    
    modal.querySelector('.bg-white').innerHTML = html;
    modal.classList.remove('hidden');
}

window.closeResults = function() {
    document.getElementById('resultsModal').classList.add('hidden');
};

// Auto-load when module loads (fallback if dashboard doesn't trigger)
console.log('üìù Online Exams module ready - v3.1');

// Auto-load exams when script loads (dashboard will show/hide section)
setTimeout(function() {
    console.log('üìù Auto-loading exams...');
    if (typeof window.loadOnlineExams === 'function') {
        loadOnlineExams();
    }
}, 500);
</script>
